<!DOCTYPE html>
<html>
<head>
  <title>イベント表 + アイコンエディタ</title>
  <style>
    #icon-editor-modal {
      display:none; position: fixed; left:0; top:0; right:0; bottom:0;
      background: rgba(0,0,0,0.3); z-index: 1000; justify-content: center; align-items: center;
    }
    #icon-editor {
      background: #fff; padding: 16px; border-radius: 8px;
      box-shadow: 0 0 20px #3334; display: flex; flex-direction: column; align-items: center;
    }
    #icon-canvas { border: 1px solid #888; background: #fff; image-rendering: pixelated; }
    #icon-palette span {
      display: inline-block; width: 20px; height: 20px; border: 1px solid #999; margin: 2px; cursor: pointer;
    }
    #icon-palette .selected { border: 2px solid #333; }
    #close-editor { margin-top: 10px; }
    table { border-collapse: collapse; }
    td,th { border:1px solid #ccc; padding:4px; }
  </style>
</head>
<body>
  <h2>イベント表</h2>
  <table id="event-table"></table>
  <button onclick="showAddForm()">イベント追加</button>
  <div id="add-form" style="display:none">
    日付: <input id="add-date">
    イベント: <input id="add-title">
    メモ: <input id="add-memo">
    <button onclick="submitAddForm()">保存</button>
    <button onclick="hideAddForm()">キャンセル</button>
  </div>
  <!-- アイコンエディタのモーダル -->
  <div id="icon-editor-modal">
    <div id="icon-editor">
      <h3>アイコン編集</h3>
      <canvas id="icon-canvas" width="200" height="200"></canvas>
      <div id="icon-palette"></div>
      <button onclick="clearIcon()">クリア</button>
      <button onclick="saveIcon()">保存</button>
      <button id="close-editor" onclick="closeIconEditor()">閉じる</button>
    </div>
  </div>
  <script>
    // --- 初期データ ---
    let events = [];
    let editingEventId = null;
    // --- アイコンエディタ ---
    const iconSize = 20;
    const iconScale = 10;
    let iconData = Array.from({length: iconSize}, () => Array(iconSize).fill("#fff"));
    const paletteColors = ["#fff","#f00","#00f","#0f0","#000","#ff0","#0ff","#f0f"];
    let currentColor = paletteColors[1];

    // --- アイコン編集モーダルの制御 ---
    function openIconEditor(eventId) {
      editingEventId = eventId;
      // アイコンデータをセット
      const event = events.find(e=>e.id===eventId);
      if(event && event.icon) {
        iconData = JSON.parse(JSON.stringify(event.icon));
      } else {
        iconData = Array.from({length: iconSize}, () => Array(iconSize).fill("#fff"));
      }
      drawIconCanvas();
      drawPalette();
      document.getElementById('icon-editor-modal').style.display = "flex";
    }
    function closeIconEditor() {
      document.getElementById('icon-editor-modal').style.display = "none";
    }
    function drawPalette() {
      const pal = document.getElementById('icon-palette'); pal.innerHTML = '';
      paletteColors.forEach(col => {
        let s = document.createElement('span');
        s.style.background = col;
        if(col===currentColor) s.className = "selected";
        s.onclick = ()=>{ currentColor=col; drawPalette(); }
        pal.appendChild(s);
      });
    }
    function drawIconCanvas() {
      const cvs = document.getElementById('icon-canvas');
      const ctx = cvs.getContext('2d');
      ctx.clearRect(0,0,iconSize*iconScale,iconSize*iconScale);
      for(let y=0;y<iconSize;y++) for(let x=0;x<iconSize;x++) {
        ctx.fillStyle = iconData[y][x];
        ctx.fillRect(x*iconScale, y*iconScale, iconScale, iconScale);
      }
      // グリッド
      ctx.strokeStyle="#ccc"; ctx.lineWidth=1;
      for(let i=1;i<iconSize;i++) {
        ctx.beginPath();
        ctx.moveTo(i*iconScale,0); ctx.lineTo(i*iconScale,iconSize*iconScale); ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0,i*iconScale); ctx.lineTo(iconSize*iconScale,i*iconScale); ctx.stroke();
      }
    }
    document.getElementById('icon-canvas').addEventListener('click', function(e){
      const rect = this.getBoundingClientRect();
      const x = Math.floor((e.clientX-rect.left)/iconScale);
      const y = Math.floor((e.clientY-rect.top)/iconScale);
      if(x>=0&&x<iconSize&&y>=0&&y<iconSize) {
        iconData[y][x]=currentColor;
        drawIconCanvas();
      }
    });
    function clearIcon() {
      iconData = Array.from({length: iconSize}, () => Array(iconSize).fill("#fff"));
      drawIconCanvas();
    }
    // 保存（API連携例）
    async function saveIcon() {
      // 編集中イベントにiconDataをセットしてPUT
      await fetch(`/api/events/${editingEventId}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({icon: iconData})
      });
      closeIconEditor();
      loadEvents();
    }

    // --- イベント表ロード&表示 ---
    async function loadEvents() {
      const res = await fetch('/api/events');
      events = await res.json();
      let html = `<tr><th>アイコン</th><th>日付</th><th>タイトル</th><th>メモ</th><th>操作</th></tr>`;
      for(const e of events) {
        html += `<tr>
          <td><canvas id="icon-thumb-${e.id}" width="40" height="40" style="image-rendering:pixelated"></canvas></td>
          <td>${e.date??""}</td>
          <td>${e.title??""}</td>
          <td>${e.memo??""}</td>
          <td>
            <button onclick="openIconEditor(${e.id})">アイコン編集</button>
            <!-- ほか編集・削除など -->
          </td>
        </tr>`;
      }
      document.getElementById('event-table').innerHTML = html;
      // アイコン描画
      for(const e of events) {
        if(e.icon) drawIconThumb(e.icon, `icon-thumb-${e.id}`);
      }
    }
    function drawIconThumb(icon, canvasId) {
      const cvs = document.getElementById(canvasId);
      if(!cvs) return;
      const ctx = cvs.getContext('2d');
      ctx.clearRect(0,0,40,40);
      for(let y=0;y<iconSize;y++) for(let x=0;x<iconSize;x++) {
        ctx.fillStyle = icon[y][x];
        ctx.fillRect(x*2, y*2, 2, 2);
      }
    }
    // --- イベント追加フォーム ---
    function showAddForm() { document.getElementById('add-form').style.display = ""; }
    function hideAddForm() { document.getElementById('add-form').style.display = "none"; }
    async function submitAddForm() {
      const data = {
        date: document.getElementById('add-date').value,
        title: document.getElementById('add-title').value,
        memo: document.getElementById('add-memo').value,
        icon: Array.from({length: iconSize}, () => Array(iconSize).fill("#fff"))
      };
      await fetch('/api/events', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      hideAddForm();
      loadEvents();
    }
    window.onload = loadEvents;
  </script>
</body>
</html>
